# Supabase æ•´åˆä»»åŠ¡è®¡åˆ’

æœ¬æ–‡æ¡£è§„åˆ’äº†ä¸º `backend` æœåŠ¡é›†æˆ Supabase å…³ç³»å‹æ•°æ®åº“ä»¥è®°å½•æ¯æ¬¡åˆ†æäº‹ä»¶çš„æ­¥éª¤ã€‚

## âœ… å®ŒæˆçŠ¶æ€

**å·²å®Œæˆçš„ä»»åŠ¡ï¼š**
- âœ… å®‰è£… Supabase Python å®¢æˆ·ç«¯åº“
- âœ… åˆ›å»º Supabase é…ç½®å’Œæ•°æ®åº“æ“ä½œæ¨¡å— (`supabase.js`)
- âœ… é›†æˆåˆ°ç°æœ‰çš„åˆ†ææµç¨‹ä¸­
- âœ… æ·»åŠ æ–°çš„ API è·¯ç”± (`/api/analysis-history`)
- âœ… æ›´æ–°ç¯å¢ƒé…ç½®æ–‡æ¡£
- âœ… åˆ›å»ºæ•°æ®åº“è¡¨ç»“æ„ SQL æ–‡ä»¶
- âœ… æ›´æ–°å¼€å‘æ–‡æ¡£

## 1. Supabase é¡¹ç›®è®¾ç½®

*   åœ¨ Supabase å¹³å°ä¸Šåˆ›å»ºä¸€ä¸ªæ–°çš„é¡¹ç›®ã€‚
*   è·å–é¡¹ç›®çš„ API å¯†é’¥å’Œ URLã€‚è¿™äº›ä¿¡æ¯å°†ç”¨äºåç«¯æœåŠ¡è¿æ¥ Supabaseã€‚

## 2. æ•°æ®åº“è¡¨ç»“æ„è®¾è®¡

*   **åˆ›å»º `analysis_events` è¡¨ï¼š** ç”¨äºå­˜å‚¨æ¯ä¸€æ¬¡å§¿æ€åˆ†æçš„äº‹ä»¶è®°å½•ã€‚
*   **å®šä¹‰è¡¨åˆ—ï¼š**
    *   `id`: äº‹ä»¶å”¯ä¸€æ ‡è¯†ç¬¦ (UUID, ä¸»é”®, è‡ªåŠ¨ç”Ÿæˆ)ã€‚
    *   `created_at`: äº‹ä»¶åˆ›å»ºæ—¶é—´æˆ³ (Timestamp with timezone, é»˜è®¤å½“å‰æ—¶é—´)ã€‚
    *   `r2_video_link`: R2 å­˜å‚¨ä¸­è§†é¢‘çš„é“¾æ¥ (TEXT)ã€‚
    *   `gemini_file_link`: ä¸Šä¼ åˆ° Gemini çš„æ–‡ä»¶é“¾æ¥ (TEXT)ã€‚
    *   `analysis_report`: æœ€ç»ˆçš„åˆ†ææŠ¥å‘Š (JSONB)ã€‚
    *   `status`: åˆ†æçŠ¶æ€ (ä¾‹å¦‚: 'pending', 'processing', 'completed', 'failed') (TEXT)ã€‚
    *   `error_message`: å¦‚æœåˆ†æå¤±è´¥ï¼Œè®°å½•é”™è¯¯ä¿¡æ¯ (TEXT, å¯é€‰)ã€‚

## 3. åç«¯é›†æˆ Supabase

*   **å®‰è£… Supabase Python å®¢æˆ·ç«¯åº“:**
    ```bash
    pip install supabase
    ```
*   **é…ç½®åç«¯è¿æ¥:**
    *   åœ¨åç«¯é…ç½®æ–‡ä»¶ä¸­å®‰å…¨åœ°å­˜å‚¨ Supabase API å¯†é’¥å’Œ URL (ä¾‹å¦‚ï¼Œä½¿ç”¨ç¯å¢ƒå˜é‡)ã€‚
    *   åˆå§‹åŒ– Supabase å®¢æˆ·ç«¯ã€‚
*   **å®ç°æ•°æ®åº“æ“ä½œå‡½æ•°:**
    *   åˆ›å»ºå‡½æ•°ç”¨äºå‘ `analysis_events` è¡¨æ’å…¥æ–°çš„äº‹ä»¶è®°å½•ã€‚
    *   åˆ›å»ºå‡½æ•°ç”¨äºæ ¹æ®éœ€è¦æ›´æ–°äº‹ä»¶çŠ¶æ€æˆ–ç»“æœã€‚
    *   (å¯é€‰) åˆ›å»ºå‡½æ•°ç”¨äºæŸ¥è¯¢åˆ†æå†å²ã€‚
*   **ä¿®æ”¹åˆ†æé€»è¾‘:**
    *   åœ¨åˆ†ææµç¨‹å¼€å§‹æ—¶ï¼Œæ’å…¥ä¸€æ¡åˆå§‹çŠ¶æ€çš„äº‹ä»¶è®°å½•ã€‚
    *   åœ¨åˆ†æå®Œæˆåï¼Œæ›´æ–°è¯¥äº‹ä»¶è®°å½•çš„çŠ¶æ€ã€ç»“æœå’Œå¤„ç†æ—¶é—´ã€‚
    *   åœ¨åˆ†æå¤±è´¥æ—¶ï¼Œæ›´æ–°äº‹ä»¶è®°å½•çš„çŠ¶æ€å’Œé”™è¯¯ä¿¡æ¯ã€‚

## 4. æµ‹è¯•

*   **å•å…ƒæµ‹è¯•:**
    *   ä¸ºæ•°æ®åº“æ“ä½œå‡½æ•°ç¼–å†™å•å…ƒæµ‹è¯•ï¼Œç¡®ä¿æ•°æ®èƒ½æ­£ç¡®æ’å…¥å’Œæ›´æ–°ã€‚
*   **é›†æˆæµ‹è¯•:**
    *   æµ‹è¯•æ•´ä¸ªåˆ†ææµç¨‹ï¼Œç¡®ä¿äº‹ä»¶åœ¨ Supabase ä¸­è¢«æ­£ç¡®è®°å½•ã€‚
    *   æµ‹è¯•ä¸åŒåˆ†æåœºæ™¯ (æˆåŠŸ, å¤±è´¥, ä¸åŒè¾“å…¥ç±»å‹)ã€‚

## 5. æ–‡æ¡£

*   æ›´æ–° `README.md` æˆ– `DEVELOPMENT.md`ï¼Œè¯´æ˜æ–°çš„æ•°æ®åº“ä¾èµ–å’Œé…ç½®æ–¹æ³•ã€‚

## (å¯é€‰) 6. å®‰å…¨ä¸ä¼˜åŒ–

*   **è¡Œçº§å®‰å…¨ (RLS):** æ ¹æ®éœ€è¦é…ç½® Supabase çš„è¡Œçº§å®‰å…¨ç­–ç•¥ï¼Œç¡®ä¿æ•°æ®è®¿é—®æƒé™ã€‚
*   **æ•°æ®åº“ç´¢å¼•:** ä¸ºç»å¸¸æŸ¥è¯¢çš„åˆ— (ä¾‹å¦‚ `created_at`, `status`) æ·»åŠ ç´¢å¼•ä»¥ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½ã€‚
*   **é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶:** ä¸ºæ•°æ®åº“æ“ä½œæ·»åŠ å¥å£®çš„é”™è¯¯å¤„ç†å’Œé‡è¯•é€»è¾‘ã€‚

## ğŸ“‹ æ¥ä¸‹æ¥çš„æ­¥éª¤

### 1. Supabase é¡¹ç›®é…ç½®
1. è®¿é—® [Supabase Dashboard](https://supabase.com/dashboard)
2. åˆ›å»ºæ–°é¡¹ç›®æˆ–é€‰æ‹©ç°æœ‰é¡¹ç›®
3. åœ¨ SQL Editor ä¸­æ‰§è¡Œ `backend/supabase_schema.sql` ä¸­çš„ SQL è¯­å¥
4. åœ¨ Settings > API ä¸­è·å–é¡¹ç›® URL å’Œ anon key
5. åœ¨ `.env` æ–‡ä»¶ä¸­é…ç½® Supabase ç¯å¢ƒå˜é‡

### 2. æµ‹è¯•é›†æˆ
```bash
# åœ¨ backend ç›®å½•ä¸‹è¿è¡Œæµ‹è¯•è„šæœ¬
node test_supabase.js
```

### 3. æ–°å¢çš„ API åŠŸèƒ½
- **GET `/api/analysis-history`**: è·å–åˆ†æå†å²è®°å½•
- åˆ†ææµç¨‹ç°åœ¨ä¼šè‡ªåŠ¨è®°å½•åˆ°æ•°æ®åº“
- æ¯ä¸ªåˆ†æäº‹ä»¶åŒ…å«ï¼šR2 è§†é¢‘é“¾æ¥ã€Gemini æ–‡ä»¶é“¾æ¥ã€åˆ†ææŠ¥å‘Š

### 4. æ•°æ®åº“è¡¨ç»“æ„
```sql
analysis_events (
    id UUID PRIMARY KEY,
    created_at TIMESTAMP,
    r2_video_link TEXT,
    gemini_file_link TEXT,
    analysis_report JSONB,
    status TEXT,
    error_message TEXT
)
```