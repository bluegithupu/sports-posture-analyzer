# Cloudflare R2 文件上传任务规划

本文档旨在规划将前端文件上传流程迁移到 Cloudflare R2，并通过后端传递视频访问地址的各项任务。

## 1. 整体流程变更

当前流程（假设）：
前端选择文件 -> 前端上传文件到后端 -> 后端处理并存储文件

新流程：
前端选择文件 -> 前端（通过预签名URL）上传文件到 Cloudflare R2 -> 前端获取 R2 中的文件 URL -> 前端将文件 URL 发送给后端 -> 后端处理该 URL（例如：存储URL，或基于URL进行后续操作）

## 2. 前端任务

### 2.1. 获取预签名 URL
- **任务描述**: 前端在用户选择文件后，需要向后端请求一个用于上传到 Cloudflare R2 的预签名 URL。
- **实现细节**:
    - 设计一个新的后端 API 接口，用于生成并返回预签名 URL。该接口可能需要文件名、文件类型等信息作为参数，以便生成针对特定对象的预签名 URL。
    - 前端调用此接口获取预签名 URL。
- **相关组件**: 文件上传组件。

### 2.2. 文件直传 R2
- **任务描述**: 使用获取到的预签名 URL，将文件直接从用户浏览器上传到 Cloudflare R2。
- **实现细节**:
    - 使用 `fetch` API 或其他 HTTP 客户端库（如 Axios）通过 `PUT` 方法将文件上传到预签名 URL。
    - 需要正确设置请求头，特别是 `Content-Type`。
    - 监控上传进度（可选，但建议以提升用户体验）。
- **相关组件**: 文件上传组件。

### 2.3. 获取 R2 文件 URL
- **任务描述**: 文件成功上传到 R2后，需要构建或从特定途径获取该文件在 R2 上的公开访问 URL。
- **实现细节**:
    - R2 的文件 URL 通常有一个固定的格式，例如 `https://<ACCOUNT_ID>.r2.cloudflarestorage.com/<BUCKET_NAME>/<OBJECT_KEY>` 或自定义域名。
    - `OBJECT_KEY` 通常是上传时的文件名或后端生成的一个唯一标识符。如果使用后端生成的预签名 URL，后端可以同时返回最终的 `OBJECT_KEY` 或完整的访问 URL。
- **相关组件**: 文件上传组件。

### 2.4. 发送 URL 到后端
- **任务描述**: 将获取到的 R2 文件 URL 发送给后端进行处理。
- **实现细节**:
    - 修改现有的后端接口，或创建一个新的接口，用于接收文件 URL。
    - 前端在文件成功上传到 R2 并获取到 URL 后，调用此接口。
- **相关组件**: 文件上传组件、与后端通信的服务。

### 2.5. UI/UX 调整
- **任务描述**: 更新用户界面以反映新的上传流程。
- **实现细节**:
    - 清晰的上传状态指示（例如：正在获取上传许可、正在上传、上传成功/失败）。
    - 错误信息展示。
- **相关组件**: 文件上传组件。

## 3. 后端任务

### 3.1. 生成预签名 URL 接口
- **任务描述**: 创建一个 API 接口，用于按需生成 Cloudflare R2 的预签名上传 URL。
- **实现细节**:
    - 使用 Cloudflare R2 的 SDK (例如, `aws-sdk` for Node.js, `boto3` for Python, 因为 R2 兼容 S3 API)。
    - 配置 R2 的 Access Key ID, Secret Access Key, Bucket Name, Region (通常是 "auto")。这些敏感信息应该通过环境变量或安全的配置管理服务加载，而不是硬编码。
    - 接口应能处理并发请求，并确保生成的 URL 具有适当的过期时间。
    - 接口可能需要接收文件名、文件类型等参数，以便生成更精确的预签名 URL，并可以用来确定最终的 `OBJECT_KEY`。
- **安全**: 确保此接口受到保护，只有授权用户才能请求预签名 URL。

### 3.2. 接收文件 URL 接口
- **任务描述**: 修改或创建 API 接口，以接收前端发送过来的 R2 文件 URL。
- **实现细节**:
    - 接口接收一个包含文件 URL 的请求。
    - 后端可以将这个 URL 存储到数据库中，关联到相应的用户或内容。
    - 后端可以根据业务需求，触发后续处理流程（例如，视频分析、元数据提取等）。
- **验证**: 验证传入的 URL 是否合法，是否符合预期的 R2 URL 格式。

### 3.3. （可选）文件处理逻辑调整
- **任务描述**: 如果后端之前直接处理文件内容，现在需要调整为处理文件 URL。
- **实现细节**:
    - 如果需要文件内容，后端服务可以根据 URL 从 R2 下载文件。
    - 更新所有依赖于直接文件访问的模块。

## 4. Cloudflare R2 配置

- **Bucket 创建与配置**:
    - 在 Cloudflare Dashboard 创建一个新的 R2 Bucket。
    - 配置 Bucket 的公开访问权限（如果视频需要直接通过 URL 被访问）。通常，对于由预签名 URL 上传的文件，其公开访问性取决于 Bucket 设置或对象本身的 ACL (如果R2支持类似S3的ACL，或通过Workers控制)。推荐设置为私有，通过Cloudflare CDN + Signed URLs/Tokens 或 Workers 来提供安全的公共访问。
    - 考虑设置 CORS (Cross-Origin Resource Sharing) 策略，允许来自前端域名的 `PUT` 请求。
- **API 凭证**:
    - 生成 R2 API Token (包含 Access Key ID 和 Secret Access Key) 并赋予必要的权限 (例如，`R2_BUCKET_READ`, `R2_BUCKET_WRITE`)。
    - 安全地存储这些凭证，供后端服务使用。
- **（可选）自定义域名**:
    - 为 R2 Bucket 配置自定义域名，使 URL 更友好。

## 5. 安全注意事项

- **凭证管理**: 后端务必安全存储 R2 API 凭证。前端不应直接接触这些凭证。
- **预签名 URL 安全**:
    - 预签名 URL 应具有尽可能短的有效时间，以减少滥用风险。
    - 后端应记录或审计预签名 URL 的生成。
- **访问控制**:
    - 确保只有认证和授权的用户才能请求预签名 URL 和提交文件 URL 到后端。
    - R2 Bucket 本身可以设置为私有，文件的公共访问可以通过 Cloudflare CDN 配合 Signed URL (Token Authentication) 或 Cloudflare Workers 来实现，这样可以更精细地控制谁可以访问以及访问时长。
- **输入验证**: 对前端发送到后端的所有数据（包括文件名、文件类型、URL）进行严格验证。

## 6. 错误处理和日志记录

- **前端**:
    - 明确提示用户上传失败的原因（网络问题、R2 错误、后端错误）。
    - 实现重试机制（可选）。
- **后端**:
    - 详细记录预签名 URL 生成、文件 URL 接收等过程中的错误。
    - 监控 R2 上传相关的 API 调用错误。

## 7. 测试

- 单元测试 (前端组件、后端 API)。
- 集成测试 (完整上传流程)。
- 安全测试 (权限、访问控制)。
- 兼容性测试 (不同浏览器、网络环境)。

## 8. 部署注意事项

- 更新CI/CD流程以包含新的后端配置（环境变量等）。
- 确保Cloudflare R2 Bucket和相关设置已在生产环境中正确配置。

## 9. 待讨论/决策点

- 最终 R2 object key 的生成策略（例如，UUID + 原始文件名，纯 UUID 等）。
- 视频文件是否需要 CDN 加速和保护？如果需要，如何配置 Cloudflare CDN 与 R2 Bucket。
- 前端上传进度条的实现细节。
- 是否需要对上传的文件类型和大小进行限制？在哪里进行限制（前端/后端/R2 Bucket策略）？

---

## 实施状态

### ✅ 已完成的任务

#### 后端任务
- ✅ **3.1 生成预签名 URL 接口** - 已实现 `/api/generate-upload-url` 接口
- ✅ **3.2 接收文件 URL 接口** - 已实现 `/api/submit-video-url` 接口  
- ✅ **3.3 文件处理逻辑调整** - 已实现 `performAnalysisFromUrl` 函数

#### 前端任务
- ✅ **2.1 获取预签名 URL** - 已在 `R2Uploader` 类中实现
- ✅ **2.2 文件直传 R2** - 已实现文件上传功能
- ✅ **2.3 获取 R2 文件 URL** - 已实现 URL 构建逻辑
- ✅ **2.4 发送 URL 到后端** - 已实现 `submitVideoUrl` 方法
- ✅ **2.5 UI/UX 调整** - 已更新主应用和文件上传组件

#### 配置和文档
- ✅ **依赖安装** - 已安装 `aws-sdk`
- ✅ **测试工具** - 已创建 `test-r2.html` 测试页面
- ✅ **部署文档** - 已创建 `R2_DEPLOYMENT.md`

### 🔄 需要配置的项目

1. **Cloudflare R2 设置**
   - 创建 R2 Bucket
   - 生成 API Token
   - 配置 CORS 策略

2. **环境变量配置**
   - 后端 `.env` 文件
   - 前端环境变量

3. **生产环境部署**
   - Vercel 环境变量设置
   - 域名配置

### 📝 使用说明

1. **开发环境测试**：
   ```bash
   # 启动后端
   cd backend && npm start
   
   # 启动前端  
   cd front && npm run dev
   
   # 访问测试页面
   http://localhost:5173/test-r2.html
   ```

2. **主应用使用**：
   - 前端已自动切换到 R2 上传模式
   - 用户界面显示云存储上传状态
   - 支持上传进度显示

此任务规划已基本完成实施。系统现在支持通过 Cloudflare R2 进行大文件上传，解决了原有的文件大小限制问题。 